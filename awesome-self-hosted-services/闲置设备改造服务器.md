# 闲置设备改造服务器实验

由于闲置安卓手机再无充当 “手机” 功能的价值，大多数人因为回收价格低廉和硬件原因一般将手机闲置。

在想着怎么将旧手机变废为宝时，想到几个方向：

1. 电视盒子。需要手机支持 视频输出协议，大多数低端机型不支持。
2. 充当服务器。现今的废旧安卓手机大多数性能 4核4g内存起步，充当服务器部署一些服务资源卓卓有余
3. 退化成组网工具，流量转发，和安装一些能运行在 termux 上的服务。

第一个若是手机是个很不错的选项，例如我现在在用的 一加9，但是手头有台 三星 galaxy s20 5g 输出到电视大屏总有个黑刘海，改分辨率也无效。

关于第二个选项 由于 android 系统其内核不支持 docker, 需要价格呢手机刷成 linux 系统，而对应的 postmarketOS 有两点好处：选择 console UI 省去资源去满足 UI 需求；原生 linux 内核，支持 docker 等服务器的普通需求。

但是手机 arm 架构不如 x86 平台开放，刷 rom 不如 x86方便，例如 postmarketOS 不一定支持所有手机，其他的 linux 如 debian, ubuntu 也不一定能装上去。此外不一定所有手机都能解锁，例如 三星 galaxy s20 5g sm-g981u1 的开发者设置界面并无 `OEM` 解锁按钮。

鉴于前两个选项对于一些手机而言都有一定难度，因此手机退化成有限服务器和组网工具。

接下来先记录 旧手机改造 linux 服务器的实验，再介绍将旧手机变成组网工具，放于不同家庭里，提供家庭服务，且利用闲置带宽资源。

## 旧手机改造为电视盒子

安卓手机充当电视盒子最主要的有一个条件是

1. 较好地支持视频输出协议（typec/microUSB 转 hdmi) 。实测三星 s20 投屏会有个刘海，一加 9 则支持比较好地投屏

剩下就是 通过alist挂载网盘，kodi 作为媒体管理系统，蓝牙遥控器连接手机操作了。

大多数中低端手机的 typeC 并非全功能的接口不支持视频输出，因此改造失败。但是有另外一个方案，网络投屏：

1. miracast：镜像屏幕，对手机和电视性能均有要求。
2. DLNA cast.：推送视频流网址给电视，电视负责下载视频流并渲染。

事实上从原理而言，网络只要延迟足够低、带宽够大，网络投屏没什么不行的。

但在实践上有些阻碍，第一个方案一些旧手机，如华为手机 荣耀8 与电视的 miracast 配合使用并不理想，只能投图片。所以引出一个新的方法，淘宝的万能无线投屏器，或者一些电视盒子自带的投屏器，如广电的盒子深深的某个角落有 miracast 这个应用。

第二个方案只能找到英文应用 xcast, localcast 两个 app，支持将本地视频和 samba nas 视频投屏，但目前找不到 webdav, 但我感觉是一个很普通的方案，可能这方面的需求被其他应用覆盖了，例如智能电视的性能越来越强，还需要投屏吗。

alist 和遥控器可自行搜索

## 闲置手机三星 Galaxy S20 刷 linux 系统

貌似是美版手机，有 esim，不支持 root, 没有 oem 解锁这个选项，没啥好说的，所以是不出意外地出了意外。

## 闲置手机华为荣耀8刷 linux 系统

过时旧手机一般会有电池老化、屏幕破碎、性能不佳等问题，刷成 postmarketOS 系统可以忽略，再持续插着电源当作服务器用，略去图形界面，4核4g ram 起步的配置是不错的服务器，且无噪音、低功耗，是个变废为宝的重要候选人，而且亲戚家的旧手机真的就是放着就放着。

步骤分为 root , bootloader 解锁 => linux 初始化 postmarket os 镜像 => 通过 fastboot 写入手机 => 开始安装

实验平台：

- 主机：Windows11, virtualBox 安装的 ubuntu 虚拟机
- 网路：虚拟机通过桥接方式连接到主机网络
- 安卓设备：华为荣耀8，已经在某宝上 root 了，并且解锁 bootloader.

实验步骤：

1. [参考 postmarketOS 安装通用教学](https://ivonblog.com/posts/postmarketos-general-installation/)。首先 ubuntu 安装必要的依赖：

   ```bash
   pip3 install --user pmbootstrap
   source ~/.profile
   sudo apt install python3-argcomplete
   tee -a $HOME/your/shell/profile/file >/dev/null <<EOT # .bashrc, .zshrc
   eval "$(register-python-argcomplete3 pmbootstrap)"
   EOF
   ```

2. 在 ubuntu 上创建 postmarketOS 镜像:

   ```bash
   #初始化
   pmbootstrap init
   
   #按Enter使用預設工作目錄 (~/.local/var/pmbootstrap)
   Work path: Enter
   
   #更新頻道選擇edge，或者填入寫有Recommended for best stability的穩定版。
   Channel: edge
   
   #選擇手機廠牌
   Vendor: xiaomi
   
   #選擇手機的裝置代號
   Device codename: beryllium
   
   #建立pmOS的使用者帳戶
   Username: User
   
   #選擇桌面環境，XFCE4(x11)適合沒有硬體加速的裝置；Phosh(Wayland，需要硬體加速)適合當手機介面。在開機後可以再另外安裝其他桌面環境。
   User Interface: phosh
   
   #剩下全部Enter
   ```

3. virtualbox ubuntu 通过数据线连接 手机。此处可能会连接不上，提示 usb设备 busy 被 windows 占用，参考[这篇文章](https://zhuanlan.zhihu.com/p/636674587) 删除一下注册表再重启 Windows 即可， 注意备份好注册表，防止出差错。重新连接，通过命令 `lsusb ` 和 `adb devices` 查看是否有设备显示即可校验连接成功与否。

4. 连接手机后, 通过下述命令以 fastboot 的方式往手机刷入系统

   ```bash
   pmbootstrap install
   pmbootstrap flasher flash_rootfs
   
   #如果刷入的分區太小，加上--partition參數，改刷入到其他分區:
   pmbootstrap flasher flash_rootfs --partition userdata
   
   pmbootstrap flasher flash_kernel
   fastboot reboot
   ```



暂时遇到一个问题：就是无论通过 pmbootstrap 写入内核 `pmbootstrap flasher flash_kernel` 还是 采用先写入 `TWRP` 刷机包 `fastboot flash recovery twrp.img` 再写 postmarketos 系统，都没有办法写进去，因为报错了，` partition size: 0` , 具体的日志见下文。

`pmbootstrap` 的日志

```bash
$ pmbootstrap log
[v20.05]
description=Old release (unsupported)
branch_pmaports=v20.05
branch_aports=3.12-stable
mirrordir_alpine=v3.12
(012559) [07:37:21] (native) flash rootfs image
(012559) [07:37:21] (native) calculate depends of android-tools (pmbootstrap -v for details)
(012559) [07:37:22] (native) install android-tools
(012559) [07:37:22] % sudo rm -f /home/hin/.local/var/pmbootstrap/chroot_native/tmp/apk_progress_fifo
(012559) [07:37:22] % sudo mkfifo /home/hin/.local/var/pmbootstrap/chroot_native/tmp/apk_progress_fifo
(012559) [07:37:22] (native) % cat /tmp/apk_progress_fifo
(012559) [07:37:22] (native) % sh -c exec 3>/tmp/apk_progress_fifo; apk --no-progress --progress-fd 3 add android-tools
(012559) [07:37:22] New background process: pid=12569, output=background
WARNING: opening /mnt/pmbootstrap-packages: No such file or directory
OK: 83 MiB in 139 packages
(012559) [07:37:23] (native) % fastboot flash userdata /home/pmos/rootfs/huawei-frd.img
Sending sparse 'userdata' 1/1 (165263 KB)          OKAY [ 39.195s]
Writing 'userdata'                                 (bootloader) success to erase cryypt info in oeminfo
OKAY [  1.693s]
Finished. Total time: 41.011s
(012559) [07:38:04] NOTE: chroot is still active (use 'pmbootstrap shutdown' as necessary)
(012559) [07:38:04] DONE!
(012602) [07:39:59] % tail -n 60 -F /home/hin/.local/var/pmbootstrap/log.txt
(012602) [07:39:59] *** output passed to pmbootstrap stdout, not to this log ***
```

日志

```bash
$ tail -n 60 -F /home/hin/.local/var/pmbootstrap/log.txt
[v20.05]
description=Old release (unsupported)
branch_pmaports=v20.05
branch_aports=3.12-stable
mirrordir_alpine=v3.12
(012559) [07:37:21] (native) flash rootfs image
(012559) [07:37:21] (native) calculate depends of android-tools (pmbootstrap -v for details)
(012559) [07:37:22] (native) install android-tools
(012559) [07:37:22] % sudo rm -f /home/hin/.local/var/pmbootstrap/chroot_native/tmp/apk_progress_fifo
(012559) [07:37:22] % sudo mkfifo /home/hin/.local/var/pmbootstrap/chroot_native/tmp/apk_progress_fifo
(012559) [07:37:22] (native) % cat /tmp/apk_progress_fifo
(012559) [07:37:22] (native) % sh -c exec 3>/tmp/apk_progress_fifo; apk --no-progress --progress-fd 3 add android-tools
(012559) [07:37:22] New background process: pid=12569, output=background
WARNING: opening /mnt/pmbootstrap-packages: No such file or directory
OK: 83 MiB in 139 packages
(012559) [07:37:23] (native) % fastboot flash userdata /home/pmos/rootfs/huawei-frd.img
Sending sparse 'userdata' 1/1 (165263 KB)          OKAY [ 39.195s]
Writing 'userdata'                                 (bootloader) success to erase cryypt info in oeminfo
OKAY [  1.693s]
Finished. Total time: 41.011s
(012559) [07:38:04] NOTE: chroot is still active (use 'pmbootstrap shutdown' as necessary)
(012559) [07:38:04] DONE!
(012602) [07:39:59] % tail -n 60 -F /home/hin/.local/var/pmbootstrap/log.txt
(012602) [07:39:59] *** output passed to pmbootstrap stdout, not to this log ***
```

检查 fastboot 分区

```bash	
hin@hin:~/.local/var/pmbootstrap/chroot_native/dev$ fastboot getvar all
all: 0.5
Finished. Total time: 0.013s
```


## 旧手机充当组网工具和基于 termux 的有限服务器


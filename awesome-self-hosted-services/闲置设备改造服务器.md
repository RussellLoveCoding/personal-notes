# 闲置设备改造服务器实验

由于闲置安卓手机再无充当 “手机” 功能的价值，大多数人因为回收价格低廉和硬件原因一般将手机闲置。而 现今的废旧安卓手机大多数性能 4核4g内存起步，充当服务器部署一些服务资源卓卓有余，但 android 系统其内核不支持 docker, 遂将手机刷成 linux 系统 postmarketOS 有两点好处：选择 console UI 省去资源去满足 UI 需求；原生 linux 内核，支持 docker 等服务器的普通需求。

所以本文目的是将闲置设备改造为 linux 服务器，变废为宝，组个低成本低功耗小小小机房方案。

安卓刷 postmarketOS 再安装 docker

surface pro4 刷 ubuntu，再装docker

将不同机器放到不同家庭的带宽，组个虚拟网络，共享资源和带宽。

以下介绍具体的实施过程

## 闲置手机华为荣耀8刷 linux 系统

过时旧手机一般会有电池老化、屏幕破碎、性能不佳等问题，刷成 postmarketOS 系统可以忽略，再持续插着电源当作服务器用，略去图形界面，4核4g ram 起步的配置是不错的服务器，且无噪音、低功耗，是个变废为宝的重要候选人，而且亲戚家的旧手机真的就是放着就放着。

步骤分为 root , bootloader 解锁 => linux 初始化 postmarket os 镜像 => 通过 fastboot 写入手机 => 开始安装

实验平台：

- 主机：Windows11, virtualBox 安装的 ubuntu 虚拟机
- 网路：虚拟机通过桥接方式连接到主机网络
- 安卓设备：华为荣耀8，已经在某宝上 root 了，并且解锁 bootloader.

实验步骤：

1. [参考 postmarketOS 安装通用教学](https://ivonblog.com/posts/postmarketos-general-installation/)。首先 ubuntu 安装必要的依赖：

   ```bash
   pip3 install --user pmbootstrap
   source ~/.profile
   sudo apt install python3-argcomplete
   tee -a $HOME/your/shell/profile/file >/dev/null <<EOT # .bashrc, .zshrc
   eval "$(register-python-argcomplete3 pmbootstrap)"
   EOF
   ```

2. 在 ubuntu 上创建 postmarketOS 镜像:

   ```bash
   #初始化
   pmbootstrap init
   
   #按Enter使用預設工作目錄 (~/.local/var/pmbootstrap)
   Work path: Enter
   
   #更新頻道選擇edge，或者填入寫有Recommended for best stability的穩定版。
   Channel: edge
   
   #選擇手機廠牌
   Vendor: xiaomi
   
   #選擇手機的裝置代號
   Device codename: beryllium
   
   #建立pmOS的使用者帳戶
   Username: User
   
   #選擇桌面環境，XFCE4(x11)適合沒有硬體加速的裝置；Phosh(Wayland，需要硬體加速)適合當手機介面。在開機後可以再另外安裝其他桌面環境。
   User Interface: phosh
   
   #剩下全部Enter
   ```

3. virtualbox ubuntu 通过数据线连接 手机。此处可能会连接不上，提示 usb设备 busy 被 windows 占用，参考[这篇文章](https://zhuanlan.zhihu.com/p/636674587) 删除一下注册表再重启 Windows 即可， 注意备份好注册表，防止出差错。重新连接，通过命令 `lsusb ` 和 `adb devices` 查看是否有设备显示即可校验连接成功与否。

4. 连接手机后, 通过下述命令以 fastboot 的方式往手机刷入系统

   ```bash
   pmbootstrap install
   pmbootstrap flasher flash_rootfs
   
   #如果刷入的分區太小，加上--partition參數，改刷入到其他分區:
   pmbootstrap flasher flash_rootfs --partition userdata
   
   pmbootstrap flasher flash_kernel
   fastboot reboot
   ```



暂时遇到一个问题：就是无论通过 pmbootstrap 写入内核 `pmbootstrap flasher flash_kernel` 还是 采用先写入 `TWRP` 刷机包 `fastboot flash recovery twrp.img` 再写 postmarketos 系统，都没有办法写进去，因为报错了，` partition size: 0` , 具体的日志见下文。

`pmbootstrap` 的日志

```bash
$ pmbootstrap log
[v20.05]
description=Old release (unsupported)
branch_pmaports=v20.05
branch_aports=3.12-stable
mirrordir_alpine=v3.12
(012559) [07:37:21] (native) flash rootfs image
(012559) [07:37:21] (native) calculate depends of android-tools (pmbootstrap -v for details)
(012559) [07:37:22] (native) install android-tools
(012559) [07:37:22] % sudo rm -f /home/hin/.local/var/pmbootstrap/chroot_native/tmp/apk_progress_fifo
(012559) [07:37:22] % sudo mkfifo /home/hin/.local/var/pmbootstrap/chroot_native/tmp/apk_progress_fifo
(012559) [07:37:22] (native) % cat /tmp/apk_progress_fifo
(012559) [07:37:22] (native) % sh -c exec 3>/tmp/apk_progress_fifo; apk --no-progress --progress-fd 3 add android-tools
(012559) [07:37:22] New background process: pid=12569, output=background
WARNING: opening /mnt/pmbootstrap-packages: No such file or directory
OK: 83 MiB in 139 packages
(012559) [07:37:23] (native) % fastboot flash userdata /home/pmos/rootfs/huawei-frd.img
Sending sparse 'userdata' 1/1 (165263 KB)          OKAY [ 39.195s]
Writing 'userdata'                                 (bootloader) success to erase cryypt info in oeminfo
OKAY [  1.693s]
Finished. Total time: 41.011s
(012559) [07:38:04] NOTE: chroot is still active (use 'pmbootstrap shutdown' as necessary)
(012559) [07:38:04] DONE!
(012602) [07:39:59] % tail -n 60 -F /home/hin/.local/var/pmbootstrap/log.txt
(012602) [07:39:59] *** output passed to pmbootstrap stdout, not to this log ***
```

日志

```bash
$ tail -n 60 -F /home/hin/.local/var/pmbootstrap/log.txt
[v20.05]
description=Old release (unsupported)
branch_pmaports=v20.05
branch_aports=3.12-stable
mirrordir_alpine=v3.12
(012559) [07:37:21] (native) flash rootfs image
(012559) [07:37:21] (native) calculate depends of android-tools (pmbootstrap -v for details)
(012559) [07:37:22] (native) install android-tools
(012559) [07:37:22] % sudo rm -f /home/hin/.local/var/pmbootstrap/chroot_native/tmp/apk_progress_fifo
(012559) [07:37:22] % sudo mkfifo /home/hin/.local/var/pmbootstrap/chroot_native/tmp/apk_progress_fifo
(012559) [07:37:22] (native) % cat /tmp/apk_progress_fifo
(012559) [07:37:22] (native) % sh -c exec 3>/tmp/apk_progress_fifo; apk --no-progress --progress-fd 3 add android-tools
(012559) [07:37:22] New background process: pid=12569, output=background
WARNING: opening /mnt/pmbootstrap-packages: No such file or directory
OK: 83 MiB in 139 packages
(012559) [07:37:23] (native) % fastboot flash userdata /home/pmos/rootfs/huawei-frd.img
Sending sparse 'userdata' 1/1 (165263 KB)          OKAY [ 39.195s]
Writing 'userdata'                                 (bootloader) success to erase cryypt info in oeminfo
OKAY [  1.693s]
Finished. Total time: 41.011s
(012559) [07:38:04] NOTE: chroot is still active (use 'pmbootstrap shutdown' as necessary)
(012559) [07:38:04] DONE!
(012602) [07:39:59] % tail -n 60 -F /home/hin/.local/var/pmbootstrap/log.txt
(012602) [07:39:59] *** output passed to pmbootstrap stdout, not to this log ***
```

检查 fastboot 分区

```bash	
hin@hin:~/.local/var/pmbootstrap/chroot_native/dev$ fastboot getvar all
all: 0.5
Finished. Total time: 0.013s
```